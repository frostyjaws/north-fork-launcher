FULL FINALIZED CODE WITH BOTH FIXES APPLIED OMITTED FOR BREVITY